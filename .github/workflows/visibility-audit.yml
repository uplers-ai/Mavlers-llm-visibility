name: LLM Visibility Audit

on:
  # Run every Sunday at 6:00 AM UTC
  schedule:
    - cron: '0 6 * * 0'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# Allow the workflow to commit and push changes
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai anthropic google-generativeai requests python-dotenv playwright
          playwright install chromium
          playwright install-deps chromium
      
      - name: Run visibility audit
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          # LLM Enable/Disable settings
          ENABLE_CHATGPT: "true"
          ENABLE_CLAUDE: "true"
          ENABLE_GEMINI: "true"
          ENABLE_GROK: "true"  # Enabled - paid API
          ENABLE_PERPLEXITY: "true"
        run: |
          python visibility_audit2.0.py --no-email || true
      
      - name: Prepare dashboard for GitHub Pages
        run: |
          # Create docs folder for GitHub Pages
          mkdir -p docs
          
          # Copy dashboard files
          cp visibility_dashboard.html docs/index.html
          cp audit_results.json docs/
          
          # Copy screenshot if exists
          if ls visibility_dashboard_*.png 1> /dev/null 2>&1; then
            cp visibility_dashboard_*.png docs/
          fi
          
          # Copy archives
          if [ -d "archives" ]; then
            cp -r archives docs/
          fi
          
          # Create a simple redirect/landing page
          cat > docs/README.md << 'EOF'
          # LLM Visibility Dashboard
          
          This dashboard is automatically updated every week.
          
          **[View Dashboard](./index.html)**
          EOF
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all generated files
          git add docs/
          git add audit_results.json || true
          git add visibility_dashboard.html || true
          git add visibility_audit.log || true
          git add archives/ || true
          
          # Commit if there are changes
          git diff --staged --quiet || git commit -m "ðŸ”„ Update visibility dashboard - $(date +'%Y-%m-%d')"
          
          # Push changes
          git push
      
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

